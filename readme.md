# Вычислитель арифметических выражений
> Контрольное задание для спринта 2 курса Программирование на Go Яндекс Лицей

## Требования
Для запуска системы необходимо наличие демона Docker, так как система запускается на Docker контейнерах, так же необходимо наличие пакета Docker Compose

Можно установить пакет [Docker Desktop](https://docs.docker.com/desktop/). Docker compose устанавливается с данным пакетом автоматически. Данный пакет есть в редакции Windows, Mac, Linux

Так же необходимо наличия установленного пакета Git, для загрузки репозитория. Впрочем данное требование не обязательно, репозиторий можно [скачать архивом с сайта GitHub](https://github.com/kozlovsv/yandex_lms_evaluator/archive/refs/heads/main.zip)

## Запуск
- Перейти в папку, в которую планируется скачать репозиторий
- Выполнить команду GIT 
```sh
git clone https://github.com/kozlovsv/yandex_lms_evaluator.git
```
- Перейти в папку с проектом и запустить bat файл `start.bat`
- Или в консоли в папке проекта выполнить команду 

```sh
docker-compose up -d --build
```
Для остановки проекта необходимо выполнить bat файл `stop.bat`
либо в консоли выполнить команду
```sh
docker-compose down
```

После постоения контейнеров и запуска, будут запущены следующие сервисы:
- База данных MySql (необходимые таблицы будут загружены в базу данных при первом запуске контейнера)
- Окрестратор
- Веб сервер на порте 80
- Агент1
- Агент2

Система имеет веб интерфейс. Для просмотра необходимо в строке браузера набрать ссылку http://127.0.0.1/

## Возможные проблемы при запуске

- Не установлен демон Docker
- Не установлен пакет Docker Compose
- Порт 3306 занят другой программой
- Порт 8001 занят другой программой
- Порт 80 занят другой программой
 
## Как пользоваться системой

В простом варианте можно пользоваться веб частью. В базе данных забиты тестовые выражения, которые при запуске оркестратора и агентов начнут вычислятся. Если сразу после первого запуска, перейти в веб часть по ссылке http://127.0.0.1/, то можно будет наблюдать процесс вычисления выражений.
Так же в веб части можно добавить на вычисление собственное выражение. Поменять настройки времени выполнения операций, посмотреть как изменится скорость вычисления выражения.
Так же можно использовать API запросы при необходимость. Описание API оркестратора будет ниже.

Если есть программа клиент для просмотра БД MySql, то можно подключиться с базе данных:
- хост: 127.0.0.1
- порт 3306
- пользователь root
- пароль testerum
 
В базе данных можно добавить в таблицу `agent` несколько собственных несуществующих агентов, которые система со временем переведет в статус Неактивен и потом удалит. Это для проверки мониторинга агентов.

## Соответствие требованиям

| Требования | Наличие |
| ------ | ------ |
| Существует Readme документ | Да |
| Можно перезапустить любой компонент системы | Да |
| Система предосталяет графический интерфей | Да |
| Реализован мониторинг воркеров | Да |
|У системы есть документация со схемами| Да |
|Выражение должно иметь возможность выполняться разными агентами| НЕТ |

## Общая схема работы системы

![Текст с описанием картинки](/images/diagram1.png)

Система состоит из следующих компонентов

- Хранилище (база данных MySQL). Так же данное хранилище используется для реализации очереди.
- Оркестратор он же сервер. Имеет API на порту 8001. Так же даный порт проксиреется веб серввером Nginx для доступа а API из вне
- Агенты (может быть много).
- Веб сервер Nginx для работы Веб страницы
- Веб страница для работы системы, разработанная на HTML + Vue.js

## Компоменты системы

### Оркестратор

Оркестратор может выполнять следующие действия

- Прием выражения на вычисление. Выражение принимаются без валидации, так как валидацию делает агент. Для добавления выражения используется ключ идемпотентности для исключения добавления одинаковых выражений при сбое либо двойном клике на веб клиенте.
- Показать список всех выражений
- Показать список настрое времени выполнения
- Изменить настройки времени выполнения
- Выдать по запросу от агента свободное выражение для вычисления
- Принять от агента и сохоранить результат вычисления
- Принять от агента и сохранить ошибку - если выражение было введено неправильго
- Так же оркестратор в отдельной горутие проверяет активность агентов. Агент каждые 30 секунт опрашивает оркестратор на наличие новых выражений, либо присылает результаты выисчлений, либо присылает пинг (если идет вычисление). При всех этих действиях оркестратор обновляет время последнего пинга в таблице агентов. Раз в секунду идет проверка последнего пинга, если время последнего пинга привысило таймаут в настройках то Агент помечается как Неактивный. Если время превысило таймаута в настройках для удаления, агент удаляетя из списка. Причем если агент "оживет" и опять сделает пинг или запрос, он будет опять добавлен в список.
- Оркестратор в отрдельной горутине проверяет раз в 1 секунду операции. Если время последнего изменения операции превысило таймаут из настроек, и выражение еще не вычислено, то данное выражение помечается свободным для вычисления, и его заберет следующий свободный агент.

В качестве сохранения состояния используется хранилище в виде базы данных `MySQL`.
В данном решении не используется какой либо сервис очередей типа `Redis` или `Rabbitmq`, для решения данной задачи было достаточно таблицы в БД.

### Агент

Агент работает по следующей схеме, при запуске он создает заданное количество горутин и начинает опрашивать сервер на предмет новых выражения для вычисления, получив выражение агент начинает вычислять его используя преобразование в обратную польскую нотацию.

Параллельность тут достигается в том что агент может параллельно вычислять несколько выражений. Тоесть тут идет параллельность когда выражений много и надо раскидать их по разным агентам и горутинам.

В задании требовалось чтобы по агентам и горутинам раскидывались операции отельного выражения. Данный функционал - не реализован.

Агент проверяет на валидность выражение, если выражение не валидно то отправляет на сервер ответ, выражение не валидно.

Если выражение валидно, агент вычисляет его и отправляет на сервер результат.

### Веб интерфейс

Веб интерфейс был разработан с использованием технологий HTML + BOOTSTRAP 5 + VUE.js


## Описание API оркестратора

Для запросов к раестратору можно использовать CURL либо программы типа Insomnia или Postman.
В общем случае прямого доступа к API не требуется так как есть Веб интерфес.

Список выражений

```sh
curl http://127.0.0.1/api/expressions
```

Конкретное выражение

```sh
curl http://127.0.0.1/api/expressions/2
```

Добавление выражения

```sh
curl -X POST http://127.0.0.1/api/expressions -H 'Content-Type: application/json' -d '{"value":"2-2*2-2","idempotency_key":"781203b4-e586-747a-87f6-e71fa8cc1b58"}'
```

Получение нового выражения для вычисления

```sh
curl http://127.0.0.1/api/get-new-task
```

Получение списка настроек

```sh
curl http://127.0.0.1/api/settings
```

Сохранение настроек

```sh
curl -X POST http://127.0.0.1/api/expressions -H 'Content-Type: application/json' -d '{"op_plus":1000,"op_minus":2000,"op_mult":3000,"op_div":4000,"op_agent_timeout":120000,"op_agent_deletetimeout":240000}'
```

Получение списка агентов
```sh
curl http://127.0.0.1/api/agents
```

