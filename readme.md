# Вычислитель арифметических выражений
> Контрольное задание для курса Программирование на Go Яндекс Лицей

## Требования
Для запуска системы необходимо наличие демона Docker, так как система запускается на Docker контейнерах, так же необходимо наличие пакета Docker Compose

Можно установить пакет [Docker Desktop](https://docs.docker.com/desktop/). Docker compose устанавливается с данным пакетом автоматически. Данный пакет есть в редакции Windows, Mac, Linux

Так же необходимо наличия установленного пакета Git, для загрузки репозитория. Впрочем данное требование не обязательно, репозиторий можно [скачать архивом с сайта GitHub](https://github.com/kozlovsv/yandex_lms_evaluator/archive/refs/heads/main.zip)

## Запуск
- Перейти в папку, в которую планируется скачать репозиторий
- Выполнить команду GIT 
```sh
git clone https://github.com/kozlovsv/yandex_lms_evaluator.git
```
- Перейти в папку с проектом и запустить bat файл `start.bat`
- Или в консоли в папке проекта выполнить команду 

```sh
docker-compose up -d
```
Для остановки проекта необходимо выполнить bat файл `stop.bat`
либо в консоли выполнить команду
```sh
docker-compose down
```

После постоения контейнеров и запуска, будут запущены следующие сервисы:
- DB База данных MySql (необходимые таблицы будут загружены в базу данных при первом запуске контейнера)
- Server Окрестратор
- WEB Веб сервер на порте 80
- Agent1 - Агент для вычислений 1
- Agent2 - Агент для вычислений 3
- Auth - сервер авторизации
- API - бакэнд для реботы веб интерфейса

Система имеет веб интерфейс. Для просмотра необходимо в строке браузера набрать ссылку http://127.0.0.1/

## Возможные проблемы при запуске

- Не установлен демон Docker
- Не установлен пакет Docker Compose
- Порт 3306 занят другой программой
- Порт 8001 занят другой программой
- Порт 80 занят другой программой
 
## Как пользоваться системой

В простом варианте можно пользоваться веб частью. http://127.0.0.1/
Сначала необходимо зарегистрироваться в системе - введя свой логин и пароль
После регистрации сразу же происходит логин. Авторизация работает на JWT токене. Срок действия 10 минут. Затем необходимо будет заново логиниться.
Так же в веб части можно добавить на вычисление собственное выражение. Поменять настройки времени выполнения операций, посмотреть как изменится скорость вычисления выражения.
Так же можно использовать API запросы при необходимость. Описание API оркестратора будет ниже.

Если есть программа клиент для просмотра БД MySql, то можно подключиться с базе данных:
- хост: 127.0.0.1
- порт 3306
- пользователь root
- пароль testerum
 
В базе данных можно добавить в таблицу `agent` несколько собственных несуществующих агентов, которые система со временем переведет в статус Неактивен и потом удалит. Это для проверки мониторинга агентов.
## JWT токен
Для авторизации используется JWT токен. Токен получается при вводе логина и пароля. 
Токен сохраняется в storage на клиенте. 
Время жизни токена 10 минут
Даные логина и пароля не сохраняются поэтому по истечении 10 минут необходимо повторно вводить логин пароль.

В данном случае исмользуется простая реализация авторизации. С ACCESS токеном. Без использования REGRESH - токена.

За авторизацию отвечает сервис Auth
Для простоты реализации сервис Auth использует ту же базу данных что и сервисы Api и Server. Хотя по уму надо бы их разделить.
## Возможности

- Система может работать только с целочисленными выражениями. Вещественные числа в выражении воспринимается как невалидное выражение
- Доступные операции + - * / и скобки
- Все символы (кроме пробела) отличные от доступных операций и чисел, будут расцениваться как невалидное выражение
- Результат выражения - вещественное значение с округленим до второго знака после запятой
- Если выражегние не валидно, то агент выдает сообщение ошибка, и в списке выражений выводится сообщение ошибка, это не ошибка в работе программы, это обозначает что выражение не валдино.

## Общая схема работы системы

![Текст с описанием картинки](/images/diagram1.png)

Система состоит из следующих компонентов

- Хранилище (база данных MySQL). Так же данное хранилище используется для реализации очереди.
- Api работает по REAT API HTTP протоколу. Осушесталяет авторизацию и выдачу JWT токенов
- Оркестратор он же сервер. Занимаетя распределением вычислений, а так же мониторингом за вычислителями (агентами). Взаимодействеи между вычислителями и сервером осуществляется по протоколу gRPC
- Вичислители (агенты), их может быть несколько. Агент - это отдельный сервис в своем докер контейнере, поэтому для добавления новых агентов необходимо внести их в файл docker-compose.yaml. Важное требование имя агента должно быть уникальное. Для примера в docker-compose.yaml размещено 2 агента, по аналогии можно добавить еще нескольких.
- Веб сервер Nginx для работы Веб страницы
- Веб страница для работы системы, разработанная на HTML + Vue.js

## Компоменты системы
### Веб интерфейс (фронт-энд)

Веб интерфейс был разработан с использованием технологий HTML + BOOTSTRAP 5 + VUE.js

### Auth

Сервер авторизации. Работает по протоколу REST API, имеет две функции login и register. Добавляет нового пользователя, либо осуществляет авторизацию по логину паролю. Возвражает JWT токен.
Срок действия токена 10 минут. После этоно необходима повторная авторизация. 

Данные хранит в общей БД MySQL

### API

Бакэнд для веб интерфейса. Работает по протоколу REST API.

Может выполнять следующие действия

- Прием выражения на вычисление. Выражение принимаются без валидации, так как валидацию делает агент. Для добавления выражения используется ключ идемпотентности для исключения добавления одинаковых выражений при сбое либо двойном клике на веб клиенте.
- Показать список всех выражений
- Показать список настроек времени выполнения
- Изменить настройки времени выполнения

В качестве сохранения состояния используется хранилище в виде базы данных `MySQL`.

### Сервер (Оркестратор)

Оркестратор использует протокол gRPC для "общения" с вычислителями. Он выполняет следующие функции.

- Выдать по запросу от агента свободное выражение для вычисления
- Принять от агента и схранить результат вычисления
- Принять от агента и сохранить ошибку - если выражение было введено неправильго

Так же оркестратор в отдельной горутие проверяет активность агентов. Агент каждые 30 секунт опрашивает оркестратор на наличие новых выражений, либо присылает результаты выисчлений, либо присылает пинг (если идет вычисление). При всех этих действиях оркестратор обновляет время последнего пинга в таблице агентов. Раз в секунду идет проверка последнего пинга, если время последнего пинга привысило таймаут в настройках то Агент помечается как Неактивный. Если время превысило таймаута в настройках для удаления, агент удаляетя из списка. Причем если агент "оживет" и опять сделает пинг или запрос, он будет опять добавлен в список.

Оркестратор в отдельной горутине проверяет раз в 1 секунду операции. Если время последнего изменения операции превысило таймаут из настроек, и выражение еще не вычислено, то данное выражение помечается свободным для вычисления, и его заберет следующий свободный агент.

В качестве сохранения состояния используется хранилище в виде базы данных `MySQL`.
В данном решении не используется какой либо сервис очередей типа `Redis` или `Rabbitmq`, для решения данной задачи было достаточно таблицы в БД.

### Агент (Вычислитель)

Агент работает по следующей схеме, при запуске он создает заданное количество горутин и начинает опрашивать сервер на предмет новых выражения для вычисления, получив выражение агент начинает вычислять его используя преобразование в обратную польскую нотацию.

Параллельность тут достигается в том что агент может параллельно вычислять несколько выражений. Тоесть тут идет параллельность когда выражений много и надо раскидать их по разным агентам и горутинам.

В задании требовалось чтобы по агентам и горутинам раскидывались операции отельного выражения. Данный функционал - не реализован.

Агент проверяет на валидность выражение, если выражение не валидно то отправляет на сервер ответ, выражение не валидно.

Если выражение валидно, агент вычисляет его и отправляет на сервер результат.

Общение агента и оркестратора происходит по протоколу gRPC



